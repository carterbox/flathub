id: org.freedesktop.Sdk.Extension.flutter
branch: "22.08"
runtime: org.freedesktop.Sdk
build-extension: true
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm14
runtime-version: "22.08"
separate-locales: false
appstream-compose: false

modules:

  - name: flutter
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/llvm14/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm14/lib
    sources:
      # For now, use patched version from personal fork
      - type: git
        branch: readonly-sdk
        url: https://github.com/carterbox/flutter.git
      # Official Release includes a pre-cached dart pub-cache to build the flutter tools
      - type: dir
        path: pub-cache
        dest: .pub-cache
      # - type: archive
      #   url: https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.3.10-stable.tar.xz
      #   sha256: d24e83f7a6b829d163feeef1abfcc30869f0c5d1af93e9917426265dad507024
      #   x-checker-data:
      #     type: anitya
      #     project-id: 236318 # https://release-monitoring.org/project/236318/
      #     stable-only: true
      #     url-template: https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_$version-stable.tar.xz
      #   dest: temp/official-release
      # Engine Dart SDK stamp
      - type: archive
        # Check bin/internal/engine.version for dart sdk path
        url: https://storage.googleapis.com/flutter_infra_release/flutter/99509a7e4275b069964c992f6e70e57ac18073d2/dart-sdk-linux-x64.zip
        sha256: 51fb771e9eab15e0759ec464fff3fdcaac1eebd6c72059a03bff0f59ba037ba5
        dest: bin/cache/dart-sdk
      # Material Font stamp
      - type: archive
        url: https://storage.googleapis.com/flutter_infra_release/flutter/fonts/3012db47f3130e62f7cc0beabff968a33cbec8d8/fonts.zip
        sha256: e56fa8e9bb4589fde964be3de451f3e5b251e4a1eafb1dc98d94add034dd5a86
        dest: bin/cache/artifacts/material_fonts
      # Gradle stamp
      - type: archive
        url: https://storage.googleapis.com/flutter_infra_release/gradle-wrapper/fd5c1f2c013565a3bea56ada6df9d2b8e96d56aa/gradle-wrapper.tgz
        sha256: 31e9428baf1a2b2f485f1110c5899f852649b33d46a2e9b07f9d17752d50190a
        dest: bin/cache/artifacts/gradle_wrapper
        strip-components: 0
      # flutter_sdk.stamp
      - type: archive
        sha256: 28db720c759afccf131dc7d942ef4aa4387841a6a7da7c788375b6eef495082b
        url: https://storage.googleapis.com/flutter_infra_release/flutter/99509a7e4275b069964c992f6e70e57ac18073d2/sky_engine.zip
        dest: bin/cache/pkg/sky_engine
      # linux-sdk.stamp
      - type: archive
        sha256: e7c82fd48ac0187904eccb032fb82e9d6702be90dc267c75dda531d5a1987b2f
        url: https://storage.googleapis.com/flutter_infra_release/flutter/99509a7e4275b069964c992f6e70e57ac18073d2/flutter_patched_sdk.zip
        dest: bin/cache/artifacts/engine/common/flutter_patched_sdk
      - type: archive
        sha256: 53c64f706dc9f4cb991569be56c57a706eaaa18f1ad3daab2d6d10020a90d01b
        url: https://storage.googleapis.com/flutter_infra_release/flutter/99509a7e4275b069964c992f6e70e57ac18073d2/flutter_patched_sdk_product.zip
        dest: bin/cache/artifacts/engine/common/flutter_patched_sdk_product
      - type: archive
        sha256: 0321807c38130449381fa04810678141167513d5fb535b100d72394b53718db4
        url: https://storage.googleapis.com/flutter_infra_release/flutter/99509a7e4275b069964c992f6e70e57ac18073d2/linux-x64/artifacts.zip
        dest: bin/cache/artifacts/engine/linux-x64
        strip-components: 0
      - type: archive
        sha256: 3a675ef58693a2e90109f575c9875944d4352deb73a8c2bf03ba086d28b5c9f3
        url: https://storage.googleapis.com/flutter_infra_release/flutter/99509a7e4275b069964c992f6e70e57ac18073d2/linux-x64/font-subset.zip
        dest: bin/cache/artifacts/engine/linux-x64
      - type: archive
        sha256: bf19df1daa4f777eb307b373803fb7393bb69eec3efe494011546afd43e17b68
        url: https://storage.googleapis.com/flutter_infra_release/flutter/99509a7e4275b069964c992f6e70e57ac18073d2/linux-x64/linux-x64-flutter-gtk.zip
        dest: bin/cache/artifacts/engine/linux-x64
        strip-components: 0
      - type: archive
        sha256: 938eb9f601f1929f26879cb38cee89c03e9144957b7bef32ea533e313d5d10e8
        url: https://storage.googleapis.com/flutter_infra_release/flutter/99509a7e4275b069964c992f6e70e57ac18073d2/linux-x64-profile/linux-x64-flutter-gtk.zip
        dest: bin/cache/artifacts/engine/linux-x64-profile
        strip-components: 0
      - type: archive
        sha256: 80a6ab0008df80964922489204ac4200fef564e336b9a497e2030b3a8d0c61ab
        url: https://storage.googleapis.com/flutter_infra_release/flutter/99509a7e4275b069964c992f6e70e57ac18073d2/linux-x64-release/linux-x64-flutter-gtk.zip
        dest: bin/cache/artifacts/engine/linux-x64-release
        strip-components: 0
      # Universal precache
      - type: archive
        sha256: e8192592626822d42417ca215ff08b55cd20fdce5df55c2e855d255b3fbde6e3
        url: https://storage.googleapis.com/flutter_infra_release/ios-usb-dependencies/libimobiledevice/2ba8188ed97d8b05670845e5b5954e2fe0f54784/libimobiledevice.zip
        dest: bin/cache/artifacts/libimobiledevice
      - type: archive
        sha256: 6e96a42e07c47e42d2921ea77ae7442e642f79295a91489059fc1f2ba102b9a9
        url: https://storage.googleapis.com/flutter_infra_release/ios-usb-dependencies/usbmuxd/c7d7d1a03f65a27be2eddb13d1f2b0c0e7a60ec6/usbmuxd.zip
        dest: bin/cache/artifacts/usbmuxd
    build-commands:
      # Stamp the archives that we downloaded manually
      - echo $(cat bin/internal/engine.version) > bin/cache/engine-dart-sdk.stamp
      - echo $(cat bin/internal/material_fonts.version) > bin/cache/material_fonts.stamp
      - rm -f bin/cache/artifacts/gradle_wrapper/NOTICE
      - rm -f bin/cache/artifacts/gradle_wrapper/gradle/wrapper/gradle-wrapper.properties
      - echo $(cat bin/internal/gradle_wrapper.version) > bin/cache/gradle_wrapper.stamp
      - echo $(cat bin/internal/engine.version) > bin/cache/flutter_sdk.stamp
      - echo $(cat bin/internal/engine.version) > bin/cache/font-subset.stamp
      - echo $(cat bin/internal/engine.version) > bin/cache/linux-sdk.stamp
      - echo $(cat bin/internal/usbmuxd.version) > bin/cache/usbmuxd.stamp
      - echo $(cat bin/internal/libimobiledevice.version) > bin/cache/libimobiledevice.stamp
      # Flutter SDK CLI (flutter tools) builds itself at first call
      - bin/flutter --version
      - bin/flutter doctor -v
      - rm -rf dev/ examples/
      - install -d /usr/lib/sdk/flutter
      - cp -rpv . /usr/lib/sdk/flutter/
      # Test that flutter doesn't complain when read-only
      - FLUTTER_ALREADY_LOCKED=true /usr/lib/sdk/flutter/bin/flutter --version
      - FLUTTER_ALREADY_LOCKED=true /usr/lib/sdk/flutter/bin/flutter doctor -v
  
  - name: scripts
    sources:
      - type: script
        commands:
          - export FLUTTER_ROOT=/usr/lib/sdk/flutter
          - export PATH=$PATH:$FLUTTER_ROOT/bin
          - export FLUTTER_ALREADY_LOCKED=true
          # We want to disable all non-Linux SDKs, but that requires access to $HOME/.config
          - flutter config
            --enable-linux-desktop
            --no-enable-android
            --no-enable-web
            --no-analytics
            --no-enable-macos-desktop
            --no-enable-windows-desktop
            --no-enable-ios
            --no-enable-fuchsia
          - alias flutter='flutter --read-only'
        dest-filename: enable.sh
    buildsystem: simple
    build-commands:
      - cp enable.sh /usr/lib/sdk/flutter/
  
  - name: appdata
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/appdata
      - cp org.freedesktop.Sdk.Extension.flutter.appdata.xml ${FLATPAK_DEST}/share/appdata
      - appstream-compose  --basename=org.freedesktop.Sdk.Extension.flutter --prefix=${FLATPAK_DEST}
        --origin=flatpak org.freedesktop.Sdk.Extension.flutter
    sources:
      - type: file
        path: org.freedesktop.Sdk.Extension.flutter.appdata.xml
